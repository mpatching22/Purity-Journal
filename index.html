<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.js"></script>
<script>

// --- SUPABASE CLIENT ---
const SUPABASE_URL = "https://dmzkhnwxxaejtexcrudm.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtemtobnd4eGFlanRleGNydWRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNDI2NDQsImV4cCI6MjA3OTkxODY0NH0.F5KmBwOiEhr7vFQZwylBK29IW3PfPtpF_tdiIMPHkIE";

// IMPORTANT FIX ‚Üí use window.supabase and rename client to `supa`
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);


// --- DATA LAYER (Supabase version) ---
const Data = {

    // Load all logs from cloud
    getLogs: async () => {
        const { data, error } = await supa
            .from('journal_entries')
            .select('*')
            .order('entry_id', { ascending: false });

        if (error) {
            console.error("Load error:", error);
            return [];
        }

        return data.map(row => ({
            id: row.entry_id,
            date: row.date,
            partner: row.partner,
            affection: row.affection,
            response: row.response,
            trigger: row.trigger,
            location: row.location,
            support: row.support,
            note: row.note
        }));
    },

    // Save entry to Supabase
    addEntry: async (entry) => {
        await supa.from('journal_entries').insert({
            entry_id: entry.id,
            date: entry.date,
            partner: entry.partner,
            affection: entry.affection,
            response: entry.response,
            trigger: entry.trigger,
            location: entry.location,
            support: entry.support,
            note: entry.note
        });
    },

    // Delete entry
    deleteEntry: async (id) => {
        if(!confirm("Delete this entry?")) return;

        await supa
            .from('journal_entries')
            .delete()
            .eq('entry_id', id);
    },

    // Export still works (pulls from cloud)
    exportJSON: async () => {
        const logs = await Data.getLogs();
        const data = JSON.stringify(logs, null, 2);
        const blob = new Blob([data], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `covenant_journal_cloud_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    },

    // Import JSON ‚Üí uploads into Supabase
    importJSON: async (input) => {
        const file = input.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const json = JSON.parse(e.target.result);

                if(Array.isArray(json)) {
                    for (const entry of json) {
                        await Data.addEntry(entry);
                    }
                    alert("Import successful!");
                }
            } catch(err) {
                alert("Error importing file.");
            }
        };
        reader.readAsText(file);
    }
};


// --- HOOK SUPABASE REALTIME ---
supa
  .channel('journal-sync')
  .on(
    "postgres_changes",
    { event: "*", schema: "public", table: "journal_entries" },
    (payload) => {
        console.log("Realtime update:", payload);
        App.renderFromCloud();
    }
  )
  .subscribe();


// --- APP (MODIFIED TO LOAD FROM SUPABASE) ---
const App = {

    init: async () => {
        document.getElementById('inpDate').value = getSydneyToday();

        const bubbles = document.getElementById('promptBubbles');
        bubbles.innerHTML = '';
        CONFIG.prompts.forEach(p => {
            const b = document.createElement('span');
            b.className = 'bubble';
            b.innerText = p;
            b.onclick = () => document.getElementById('inpNote').value += `\n- ${p} `;
            bubbles.appendChild(b);
        });

        await App.renderFromCloud();
    },

    renderFromCloud: async () => {
        window.__ALL_LOGS__ = await Data.getLogs();
        App.render();
    },

    saveEntry: async () => {
        const ids = ['inpDate','inpPartner','inpAffection','inpResponse','inpTrigger','inpLocation','inpSupport','inpNote'];
        const v = {};
        ids.forEach(id => v[id] = document.getElementById(id).value);

        if(!v.inpAffection || !v.inpResponse) {
            alert("Please select Affection and Response.");
            return;
        }

        const entry = {
            id: Date.now(),
            date: v.inpDate,
            partner: v.inpPartner,
            affection: v.inpAffection,
            response: v.inpResponse,
            trigger: v.inpTrigger,
            location: v.inpLocation,
            support: v.inpSupport,
            note: v.inpNote
        };

        await Data.addEntry(entry);

        document.getElementById('inpNote').value = '';
        document.getElementById('inpAffection').value = '';
        document.getElementById('inpResponse').value = '';
    },

    render: () => {
        const allLogs = window.__ALL_LOGS__ || [];
        const timeFilter = document.getElementById('filterTime').value;
        const partnerFilter = document.getElementById('filterPartner').value;

        const logs = Stats.filterLogs(allLogs, timeFilter, partnerFilter);

        const score = Stats.getPurityScore(logs);
        document.getElementById('stat-streak').innerText = Stats.getStreak(allLogs);
        document.getElementById('stat-purity').innerText = score;
        document.getElementById('stat-response').innerText = Stats.getResponseAvg(logs) + " / 5.0";
        document.getElementById('stat-support').innerText = logs.filter(l => l.support !== 'None').length;
        document.getElementById('stat-entries').innerText = logs.length;

        const insight = Stats.generateInsight(logs, score);
        document.getElementById('msg-title').innerText = insight.title;
        document.getElementById('msg-body').innerText = insight.body;

        App.renderCharts(logs);

        const container = document.getElementById('log-container');
        container.innerHTML = '';

        if(logs.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#999">No entries found for this period.</p>';
            return;
        }

        const weeks = {};
        logs.forEach(l => {
            const d = new Date(l.date);
            const day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6:1);
            const monday = new Date(d.setDate(diff)).toISOString().slice(0,10);
            if(!weeks[monday]) weeks[monday] = [];
            weeks[monday].push(l);
        });

        Object.keys(weeks).sort().reverse().forEach(weekStart => {
            const wLogs = weeks[weekStart];

            const countA3 = wLogs.filter(l => ['A3','A4'].includes(l.affection)).length;
            const countR1 = wLogs.filter(l => ['R1','R2'].includes(l.response)).length;
            const bestMsg = countR1 > 0 ? `${countR1} Early Redirections` : "Keep striving";

            const group = document.createElement('div');
            group.innerHTML = `
                <div class="week-header">
                    <span>Week of ${weekStart}</span>
                </div>
                <div class="week-summary">
                    <div class="summary-block">
                        <h4>Risk Profile</h4>
                        ${countA3 > 0 ? '<span style="color:var(--c-red)">‚ö†Ô∏è High Risk Detected</span>' : '<span style="color:var(--c-green)">üåø Low Risk Week</span>'}
                    </div>
                    <div class="summary-block">
                        <h4>Highlights</h4>
                        <span>${bestMsg}</span>
                    </div>
                </div>
            `;

            wLogs.forEach(entry => {
                const sA = CONFIG.styles[entry.affection] || CONFIG.styles['A0'];
                const sR = CONFIG.styles[entry.response] || CONFIG.styles['R0'];

                const div = document.createElement('div');
                div.className = `log-entry ${sA.border}`;
                div.innerHTML = `
                    <div class="entry-meta">
                        <span>${new Date(entry.date).toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric'})} ‚Ä¢ üë§ ${entry.partner}</span>
                        <span style="cursor:pointer; color:#C62828;" onclick="Data.deleteEntry(${entry.id})">&times;</span>
                    </div>
                    <div class="tags-row">
                        <span class="tag" style="background:${sA.bg}; color:${sA.c}">${entry.affection}</span>
                        <span class="tag" style="background:${sR.bg}; color:${sR.c}">${entry.response}</span>
                        ${entry.support !== 'None' ? `<span class="tag" style="background:#E3F2FD; color:#1565C0">${entry.support}</span>` : ''}
                    </div>
                    ${entry.trigger !== 'None' ? `<div style="font-size:0.85rem; color:#666; margin-bottom:5px;">üìç ${entry.trigger} (${entry.location})</div>` : ''}
                    <div style="font-style:italic; color:#444;">"${entry.note}"</div>
                `;
                group.appendChild(div);
            });

            container.appendChild(group);
        });
    }
};

window.onload = App.init;

</script>
